include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

stages:
  - sast
  - secret_detection
  - build

# Shared job template (replaces docker-build.yml in GitHub)
.docker-build-template:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - echo "Logging into GitLab Container Registry"
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

    # Normalize names to lowercase
    - IMAGE=$(echo "${IMAGE_NAME}:${CI_COMMIT_SHA}" | tr '[:upper:]' '[:lower:]')
    - LATEST=$(echo "${IMAGE_NAME}:latest" | tr '[:upper:]' '[:lower:]')

    - echo "Building $IMAGE"
    - docker build -t "$IMAGE" "$BUILD_PATH"
    - docker tag "$IMAGE" "$LATEST"

    - echo "Pushing images"
    - docker push "$IMAGE"
    - docker push "$LATEST"

# Backend job
backend-build:
  extends: .docker-build-template
  variables:
    SERVICE: "backend"
    BUILD_PATH: "./backend"
    IMAGE_NAME: "$CI_REGISTRY_IMAGE/linksphere-backend"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
      changes:
        - backend/**/*

# Frontend job
frontend-build:
  extends: .docker-build-template
  variables:
    SERVICE: "frontend"
    BUILD_PATH: "./frontend"
    IMAGE_NAME: "$CI_REGISTRY_IMAGE/linksphere-frontend"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
      changes:
        - frontend/**/*
